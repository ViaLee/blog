<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>React | ğŸ’«Viaã®blog</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/babe.png">
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.795a5f26.css" as="style"><link rel="preload" href="/assets/js/app.fe865785.js" as="script"><link rel="preload" href="/assets/js/2.2bb9bc7d.js" as="script"><link rel="preload" href="/assets/js/23.7f4e1523.js" as="script"><link rel="prefetch" href="/assets/js/10.591d8c83.js"><link rel="prefetch" href="/assets/js/11.16d2a7bb.js"><link rel="prefetch" href="/assets/js/12.8a322b0d.js"><link rel="prefetch" href="/assets/js/13.bdf74619.js"><link rel="prefetch" href="/assets/js/14.6dc3f813.js"><link rel="prefetch" href="/assets/js/15.d0e50ae2.js"><link rel="prefetch" href="/assets/js/16.0e1286b9.js"><link rel="prefetch" href="/assets/js/17.2e111bb5.js"><link rel="prefetch" href="/assets/js/18.a41f8031.js"><link rel="prefetch" href="/assets/js/19.44712e48.js"><link rel="prefetch" href="/assets/js/20.f905de50.js"><link rel="prefetch" href="/assets/js/21.b6b96b81.js"><link rel="prefetch" href="/assets/js/22.ad9ea00f.js"><link rel="prefetch" href="/assets/js/24.65112157.js"><link rel="prefetch" href="/assets/js/25.507c072c.js"><link rel="prefetch" href="/assets/js/26.db36ca72.js"><link rel="prefetch" href="/assets/js/27.7e1bc857.js"><link rel="prefetch" href="/assets/js/3.5e79d895.js"><link rel="prefetch" href="/assets/js/4.698721cf.js"><link rel="prefetch" href="/assets/js/5.9461c3e6.js"><link rel="prefetch" href="/assets/js/6.302d11f3.js"><link rel="prefetch" href="/assets/js/7.978cfa82.js"><link rel="prefetch" href="/assets/js/8.d9a970f8.js"><link rel="prefetch" href="/assets/js/9.0b05021a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.795a5f26.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/babe.png" alt="ğŸ’«Viaã®blog" class="logo"> <span class="site-name can-hide">ğŸ’«Viaã®blog</span></a> <div class="links"><!----> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ReactğŸŒ´" class="dropdown-title"><span class="title">ReactğŸŒ´</span> <span class="arrow down"></span></button> <button type="button" aria-label="ReactğŸŒ´" class="mobile-dropdown-title"><span class="title">ReactğŸŒ´</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/reactCode.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  åº•å±‚
</a></li><li class="dropdown-item"><!----> <a href="/pages/react.html" class="nav-link">
  å…¶ä»–
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Basic ğŸ³" class="dropdown-title"><span class="title">Basic ğŸ³</span> <span class="arrow down"></span></button> <button type="button" aria-label="Basic ğŸ³" class="mobile-dropdown-title"><span class="title">Basic ğŸ³</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/javascript.html" class="nav-link">
  JS
</a></li><li class="dropdown-item"><!----> <a href="/pages/css.html" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/pages/webpack.html" class="nav-link">
  Webpack
</a></li><li class="dropdown-item"><!----> <a href="/pages/flutter.html" class="nav-link">
  Flutter
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Web ğŸŒ" class="dropdown-title"><span class="title">Web ğŸŒ</span> <span class="arrow down"></span></button> <button type="button" aria-label="Web ğŸŒ" class="mobile-dropdown-title"><span class="title">Web ğŸŒ</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/http.html" class="nav-link">
  HTTP
</a></li><li class="dropdown-item"><!----> <a href="/pages/browser.html" class="nav-link">
  æµè§ˆå™¨
</a></li></ul></div></div><div class="nav-item"><a href="/pages/node.html" class="nav-link">
  Node â˜ï¸
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Blog âœğŸ»" class="dropdown-title"><span class="title">Blog âœğŸ»</span> <span class="arrow down"></span></button> <button type="button" aria-label="Blog âœğŸ»" class="mobile-dropdown-title"><span class="title">Blog âœğŸ»</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/blog.html" class="nav-link">
  åšå®¢ âœğŸ»
</a></li><li class="dropdown-item"><!----> <a href="/pages/log.html" class="nav-link">
  ERROR âŒ
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="ReactğŸŒ´" class="dropdown-title"><span class="title">ReactğŸŒ´</span> <span class="arrow down"></span></button> <button type="button" aria-label="ReactğŸŒ´" class="mobile-dropdown-title"><span class="title">ReactğŸŒ´</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/reactCode.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  åº•å±‚
</a></li><li class="dropdown-item"><!----> <a href="/pages/react.html" class="nav-link">
  å…¶ä»–
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Basic ğŸ³" class="dropdown-title"><span class="title">Basic ğŸ³</span> <span class="arrow down"></span></button> <button type="button" aria-label="Basic ğŸ³" class="mobile-dropdown-title"><span class="title">Basic ğŸ³</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/javascript.html" class="nav-link">
  JS
</a></li><li class="dropdown-item"><!----> <a href="/pages/css.html" class="nav-link">
  CSS
</a></li><li class="dropdown-item"><!----> <a href="/pages/webpack.html" class="nav-link">
  Webpack
</a></li><li class="dropdown-item"><!----> <a href="/pages/flutter.html" class="nav-link">
  Flutter
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Web ğŸŒ" class="dropdown-title"><span class="title">Web ğŸŒ</span> <span class="arrow down"></span></button> <button type="button" aria-label="Web ğŸŒ" class="mobile-dropdown-title"><span class="title">Web ğŸŒ</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/http.html" class="nav-link">
  HTTP
</a></li><li class="dropdown-item"><!----> <a href="/pages/browser.html" class="nav-link">
  æµè§ˆå™¨
</a></li></ul></div></div><div class="nav-item"><a href="/pages/node.html" class="nav-link">
  Node â˜ï¸
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Blog âœğŸ»" class="dropdown-title"><span class="title">Blog âœğŸ»</span> <span class="arrow down"></span></button> <button type="button" aria-label="Blog âœğŸ»" class="mobile-dropdown-title"><span class="title">Blog âœğŸ»</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/blog.html" class="nav-link">
  åšå®¢ âœğŸ»
</a></li><li class="dropdown-item"><!----> <a href="/pages/log.html" class="nav-link">
  ERROR âŒ
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>React</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/reactCode.html#å®Œæ•´æµç¨‹" class="sidebar-link">å®Œæ•´æµç¨‹</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/pages/reactCode.html#æ—¶é—´åˆ‡ç‰‡" class="sidebar-link">æ—¶é—´åˆ‡ç‰‡</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/reactCode.html#requestframeanimation" class="sidebar-link">requestFrameAnimation</a></li><li class="sidebar-sub-header"><a href="/pages/reactCode.html#requestidlecallback" class="sidebar-link">requestIdleCallback</a></li><li class="sidebar-sub-header"><a href="/pages/reactCode.html#web-é€šä¿¡" class="sidebar-link">web é€šä¿¡</a></li><li class="sidebar-sub-header"><a href="/pages/reactCode.html#react-v16-0-0-raf-postmessage" class="sidebar-link">react v16.0.0 rAF + postMessage</a></li><li class="sidebar-sub-header"><a href="/pages/reactCode.html#react-v16-2-0-messagechannel" class="sidebar-link">react v16.2.0+ MessageChannel</a></li></ul></li><li><a href="/pages/reactCode.html#render-é˜¶æ®µ" class="sidebar-link">render é˜¶æ®µ</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/reactCode.html#diff" class="sidebar-link">diff</a></li><li class="sidebar-sub-header"><a href="/pages/reactCode.html#update-è®¡ç®—" class="sidebar-link">update è®¡ç®—</a></li><li class="sidebar-sub-header"><a href="/pages/reactCode.html#ä¼˜å…ˆçº§è°ƒåº¦" class="sidebar-link">ä¼˜å…ˆçº§è°ƒåº¦</a></li></ul></li><li><a href="/pages/reactCode.html#commit-é˜¶æ®µ" class="sidebar-link">commit é˜¶æ®µ</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="react"><a href="#react" class="header-anchor">#</a> React</h1> <h2 id="å®Œæ•´æµç¨‹"><a href="#å®Œæ•´æµç¨‹" class="header-anchor">#</a> å®Œæ•´æµç¨‹</h2> <p>è§¦å‘æ›´æ–°ï¼ˆReactDom.render,classcomponent,fncomponentï¼‰<br>
â€ƒâ€ƒ|<br>
â€ƒâ€ƒ|<br>
â€ƒâ€ƒâ†“<br>
â€ƒè°ƒåº¦<br>
â€ƒâ€ƒ|<br>
â€ƒâ€ƒ|<br>
â€ƒâ€ƒâ†“<br>
render é˜¶æ®µ<br>
â€ƒâ€ƒ|<br>
â€ƒâ€ƒ|<br>
â€ƒâ€ƒâ†“<br>
commit é˜¶æ®µ</p> <h2 id="æ—¶é—´åˆ‡ç‰‡"><a href="#æ—¶é—´åˆ‡ç‰‡" class="header-anchor">#</a> æ—¶é—´åˆ‡ç‰‡</h2> <p>FPS(frame per second) æ¯ç§’æ˜¾ç¤ºå¸§æ•°<br>
æµè§ˆå™¨ä¸€å¸§å¹²äº†äº›å•¥<br> <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/13528958b6804c16a1dafb613d24b8a9~tplv-k3u1fbpfcp-zoom-in-crop-mark:4536:0:0:0.awebp" alt="fps"></p> <h3 id="requestframeanimation"><a href="#requestframeanimation" class="header-anchor">#</a> requestFrameAnimation</h3> <h4 id="åŸºæœ¬ç”¨æ³•"><a href="#åŸºæœ¬ç”¨æ³•" class="header-anchor">#</a> åŸºæœ¬ç”¨æ³•</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">let</span> <span class="token function-variable function">fn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">animation</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&gt;</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>

  dom<span class="token punctuation">.</span>style<span class="token punctuation">.</span>marginLeft <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  count<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
Window<span class="token punctuation">.</span><span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
Window<span class="token punctuation">.</span><span class="token function">cancelAnimationFrame</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>æ¯ä¸€å¸§åªä¼šè°ƒç”¨ä¸€æ¬¡ rAF</p></blockquote> <h4 id="å…¼å®¹æ€§"><a href="#å…¼å®¹æ€§" class="header-anchor">#</a> å…¼å®¹æ€§</h4> <p>ç†è®ºä¸Šä¸èƒ½ä½¿ç”¨ setTimeout å…œåº•ï¼š<br>
å½“æ‰§è¡Œå®Œ setTimeout å›è°ƒåï¼Œæµè§ˆå™¨å‘ç°è¿˜æœ‰æ—¶é—´ï¼Œäºæ˜¯åˆæ‰§è¡Œäº†å‡ æ¬¡ setTimeout å›è°ƒï¼Œæœ€åå†ä¸€èµ·æ¸²æŸ“ï¼Œæ‰€ä»¥åœ¨åŸæœ¬ä¸€å¸§çš„æ—¶é—´å†…æ‰§è¡Œäº†å¤šæ¬¡ setTimeout å›è°ƒï¼ŒåŠ¨ç”»è‡ªç„¶å°±ä¼šå¿«å¾ˆå¤šã€‚ä¸” setTimeout æœ‰æœ€ä½ 4ms å»¶æ—¶ã€‚</p> <h3 id="requestidlecallback"><a href="#requestidlecallback" class="header-anchor">#</a> requestIdleCallback</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">callback</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token parameter">deadline</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>deadline<span class="token punctuation">.</span>didTimeout<span class="token punctuation">)</span> <span class="token comment">//æ˜¯å¦åœ¨è¶…æ—¶å‰å·²å®Œæˆ</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>deadline<span class="token punctuation">.</span><span class="token function">timeRemaining</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//æœ¬æ¬¡ç©ºé—²å‘¨æœŸå†…å‰©ä½™æ—¶é—´</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> handle <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token function">requestIdleCallback</span><span class="token punctuation">(</span>callback<span class="token punctuation">[</span><span class="token punctuation">,</span> options<span class="token punctuation">]</span><span class="token punctuation">)</span>
Window<span class="token punctuation">.</span><span class="token function">cancelIdleCallback</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span>  <span class="token comment">//å–æ¶ˆ</span>
</code></pre></div><ul><li>requestIdleCallback æ¯ç§’åªä¼šè¢«æ‰§è¡Œ 20 æ¬¡ï¼Œä¸€ä¸ªç©ºé—²å‘¨æœŸæœ€é•¿ 50ms</li> <li>ä½ä¼˜å…ˆçº§çš„ä»»åŠ¡é€‚ç”¨</li></ul> <h3 id="web-é€šä¿¡"><a href="#web-é€šä¿¡" class="header-anchor">#</a> web é€šä¿¡</h3> <p>éƒ½å±äºå®ä»»åŠ¡</p> <ol><li>è·¨æ–‡æ¡£é€šä¿¡ PostMessageï¼Œæ–¹æ³•å¯ä»¥å®‰å…¨åœ°å®ç°è·¨æºé€šä¿¡ã€‚</li> <li>é€šé“é€šä¿¡ MessageChannel</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">var</span> channel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MessageChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
channel<span class="token punctuation">.</span>port1<span class="token punctuation">.</span><span class="token function-variable function">onmessage</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
channel<span class="token punctuation">.</span>port2<span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Hello World&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="react-v16-0-0-raf-postmessage"><a href="#react-v16-0-0-raf-postmessage" class="header-anchor">#</a> react v16.0.0 rAF + postMessage</h3> <ol><li>è·å–å½“å‰å¸§æœ€æ™šç»“æŸæ—¶é—´ï¼ˆå½“å‰æ‰§è¡Œæ—¶é—´ + 33msï¼‰</li> <li>postmessage æ¨å…¥ä¸€ä¸ªä»»åŠ¡ï¼ˆå®Œæˆå…¶ä»–ä»»åŠ¡ä¹‹åï¼‰<br>
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ†“</li> <li>æ‰§è¡Œ messageListenr å›è°ƒ, è·å–å½“å‰å¸§å‰©ä½™æ—¶é—´</li> <li>å°†å‰©ä½™æ—¶é—´ä¼ å…¥åˆ° rAF çš„ callback å‡½æ•°ä¸­</li></ol> <blockquote><p>requestAnimationFrame() ä¼šè¢«æš‚åœè°ƒç”¨ä»¥æå‡æ€§èƒ½å’Œç”µæ± å¯¿å‘½ï¼Œä¼šå½±å“ react æ‰§è¡Œã€‚</p></blockquote> <h3 id="react-v16-2-0-messagechannel"><a href="#react-v16-2-0-messagechannel" class="header-anchor">#</a> react v16.2.0+ MessageChannel</h3> <p>flushWork è¿”å›æ˜¯å¦è¿˜æœ‰æœªå®Œæˆçš„ä»»åŠ¡ï¼Œå¦‚æœæœ‰åˆ™ä¼šè¿›è¡Œä¸‹ä¸€æ¬¡ PostMessageï¼Œè®©å‡ºçº¿ç¨‹ï¼Œå‘Šè¯‰æµè§ˆå™¨æ‰§è¡Œå®Œé«˜ä¼˜ä»»åŠ¡åç»§ç»­æ‰§è¡Œï¼Œè¿›å…¥ä¸‹ä¸€ä¸ªåˆ‡ç‰‡</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">flushWork</span><span class="token punctuation">(</span><span class="token parameter">hasTimeRemaining<span class="token punctuation">,</span> initialTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">workLoop</span><span class="token punctuation">(</span>hasTimeRemaining<span class="token punctuation">,</span> initialTime<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> currentTask<span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">workLoop</span><span class="token punctuation">(</span><span class="token parameter">hasTimeRemaining<span class="token punctuation">,</span> initialTime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  currentTask <span class="token operator">=</span> taskQueue<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// 1.ä»ä»»åŠ¡é˜Ÿåˆ—ç¬¬ä¸€ä¸ªå¼€å§‹éå†æ‰§è¡Œ</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>currentTask <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 2.å·²æ— å‰©ä½™æ—¶é—´æˆ–ä¸»åŠ¨äº¤è¿˜æ‰§è¡Œæƒåˆ™è·³å‡ºéå†</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      currentTask<span class="token punctuation">.</span>expirationTime <span class="token operator">&gt;</span> initialTime <span class="token operator">&amp;&amp;</span>
      <span class="token punctuation">(</span><span class="token operator">!</span>hasTimeRemaining <span class="token operator">||</span> <span class="token function">shouldYieldToHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 3.æ‰§è¡Œå›è°ƒã€ä»ä»»åŠ¡é˜Ÿåˆ—ç§»é™¤è¯¥ä»»åŠ¡</span>
    <span class="token keyword">const</span> callback <span class="token operator">=</span> currentTask<span class="token punctuation">.</span>callback<span class="token punctuation">;</span>
    <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    taskQueue<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    currentTask <span class="token operator">=</span> taskQueue<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 4. è¿”å›æ˜¯å¦è¿˜æœ‰æœªå®Œæˆçš„ä»»åŠ¡</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>currentTask <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// é»˜è®¤çš„æ—¶é—´åˆ‡ç‰‡</span>
<span class="token keyword">const</span> frameInterval <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token comment">// 5. å¦‚æœå½“å‰æ—¶é—´ - å¼€å§‹æ—¶é—´ï¼Œå³æ‰§è¡Œæ—¶é—´ï¼Œå¤§äºæ—¶é—´åˆ‡ç‰‡é¢„è®¾æ—¶é—´åˆ™ä¸»åŠ¨ä¸­æ–­</span>
<span class="token keyword">function</span> <span class="token function">shouldYieldToHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> timeElapsed <span class="token operator">=</span> <span class="token function">getCurrentTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> startTime<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>timeElapsed <span class="token operator">&lt;</span> frameInterval<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="render-é˜¶æ®µ"><a href="#render-é˜¶æ®µ" class="header-anchor">#</a> render é˜¶æ®µ</h2> <h3 id="diff"><a href="#diff" class="header-anchor">#</a> diff</h3> <p>é™åˆ¶ï¼š</p> <ol><li>åŒçº§</li> <li>åŒç§å…ƒç´ </li> <li>å¯é€šè¿‡è®¾ç½® key æ‰“ç ´é™åˆ¶ 2</li></ol> <p>diff åˆ†ä¸¤ç§æƒ…å†µï¼š</p> <ol><li>å•ä¸€èŠ‚ç‚¹ åˆ¤æ–­ key æ˜¯å¦ä¸€è‡´ã€åˆ¤æ–­æ˜¯å¦ä¸ºåŒç§å…ƒç´  â€ƒ--æ˜¯--&gt; æ ¹æ® currentfiber clone createFiber
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒ â†“ å¦<br>
â€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒâ€ƒ æ ‡è®°åˆ é™¤ dom,åˆ›å»º newfiber</li> <li>å¤šèŠ‚ç‚¹
å¯¹æ¯”æ›´æ–°å‰åçš„ nodeList,ä¸º node æ ‡è®° flag,éœ€è¦è€ƒè™‘æ˜¯ä»¥ä¸‹ä¸‰ç§æƒ…å†µçš„å“ªç§æƒ…å†µï¼š</li></ol> <ul><li>èŠ‚ç‚¹å±æ€§å˜åŒ–</li> <li>èŠ‚ç‚¹å¢åˆ </li> <li>èŠ‚ç‚¹ä½ç½®ç§»åŠ¨<br>
ä¸‰ç§æƒ…å†µçš„å¤„ç†é€»è¾‘ä¸åŒï¼Œ1 æƒ…å†µæ›´å¸¸è§ã€‚<br>
ç»å†ä¸¤è½®éå†ï¼Œé¦–è½®ä¼˜å…ˆå¤„ç†å¸¸è§æƒ…å†µ 1ï¼Œç¬¬äºŒè½®åå…¶ä»–æƒ…å†µã€‚</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// è™šæ‹ŸdomèŠ‚ç‚¹æ•°æ®ç»“æ„</span>
type flag <span class="token operator">=</span> <span class="token string">&quot;Placement&quot;</span> <span class="token operator">|</span> <span class="token string">&quot;Deletion&quot;</span><span class="token punctuation">;</span> <span class="token comment">//Placementæ–°å¢æˆ–ç§»åŠ¨ï¼ŒDeletionåˆ é™¤</span>
<span class="token keyword">interface</span> <span class="token class-name">Node</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">key</span><span class="token operator">:</span> string<span class="token punctuation">;</span> <span class="token comment">//nodeçš„å”¯ä¸€æ ‡è¯†</span>
  flag<span class="token operator">?</span><span class="token operator">:</span> Flag<span class="token punctuation">;</span> <span class="token comment">// æ ‡è®°æ“ä½œç±»å‹</span>
  index<span class="token operator">?</span><span class="token operator">:</span> number<span class="token punctuation">;</span> <span class="token comment">//è¯¥nodeåœ¨åŒçº§nodeä¸­çš„ç´¢å¼•ä½ç½®</span>
<span class="token punctuation">}</span>

type NodeList <span class="token operator">=</span> Node<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">diff</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">before</span><span class="token operator">:</span> NodeList<span class="token punctuation">,</span> <span class="token literal-property property">after</span><span class="token operator">:</span> NodeList</span><span class="token punctuation">)</span><span class="token operator">:</span> NodeList <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token literal-property property">result</span><span class="token operator">:</span>NodeList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token comment">// éå†å‰å‡†å¤‡å·¥ä½œ</span>
  <span class="token comment">// 1.éœ€è¦å­˜ä¸€ä»½beforeNode,ä¸”ä»¥O(1)å¤æ‚åº¦å°±èƒ½æ‰¾åˆ°å¯¹åº”çš„node</span>
  <span class="token keyword">const</span> beforeMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token operator">&lt;</span>string<span class="token punctuation">,</span>Node<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  before<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">node<span class="token punctuation">,</span>i</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    node<span class="token punctuation">.</span>index<span class="token operator">=</span>i<span class="token punctuation">;</span>
    beforeMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>key<span class="token punctuation">,</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// 2.éå†after,å¯¹æ¯”beforeï¼Œafterï¼Œéƒ½å­˜åœ¨çš„nodeï¼Œå¯å¤ç”¨ï¼Œå°†å­˜åœ¨ä¸¤ç§æƒ…å†µï¼šç§»åŠ¨ã€ä¸ç§»åŠ¨ï¼Œå¦‚ä½•åˆ¤æ–­ï¼Ÿ</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>after<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// éå†é€»è¾‘</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>demo1:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// æ›´æ–°å‰</span>
<span class="token keyword">const</span> before <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">&quot;a&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">// æ›´æ–°å</span>
<span class="token keyword">const</span> after <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">{</span> <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">&quot;d&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token function">diff</span><span class="token punctuation">(</span>before<span class="token punctuation">,</span> after<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/*
[
  {key:'a',flag:&quot;Deletion&quot;},
  {key:'d',flag:&quot;Placement&quot;}
]
*/</span>
</code></pre></div><p>demo2:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// æ›´æ–°å‰</span>
<span class="token keyword">const</span> before <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span><span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">'a'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">'b'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">'c'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span>
<span class="token comment">// æ›´æ–°å</span>
<span class="token keyword">const</span> after <span class="token operator">=</span> <span class="token punctuation">[</span>
  <span class="token punctuation">{</span><span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">'c'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">'b'</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span><span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">'a'</span><span class="token punctuation">}</span>
<span class="token punctuation">]</span>

<span class="token function">diff</span><span class="token punctuation">(</span>before<span class="token punctuation">,</span> after<span class="token punctuation">)</span> è¾“å‡º
<span class="token comment">/*
[
  {key: &quot;b&quot;, flag: &quot;Placement&quot;},
  {key: &quot;a&quot;, flag: &quot;Placement&quot;}
]

ç”±äºbä¹‹å‰å·²ç»å­˜åœ¨ï¼Œ{key: &quot;b&quot;, flag: &quot;Placement&quot;}ä»£è¡¨bå¯¹åº”DOMéœ€è¦å‘åç§»åŠ¨ï¼ˆå¯¹åº”parentNode.appendChildæ–¹æ³•ï¼‰ã€‚abcç»è¿‡è¯¥æ“ä½œåå˜ä¸ºacbã€‚

ç”±äºaä¹‹å‰å·²ç»å­˜åœ¨ï¼Œ{key: &quot;a&quot;, flag: &quot;Placement&quot;}ä»£è¡¨aå¯¹åº”DOMéœ€è¦å‘åç§»åŠ¨ã€‚acbç»è¿‡è¯¥æ“ä½œåå˜ä¸ºcbaã€‚

æ‰§è¡Œåçš„ç»“æœå°±æ˜¯ï¼šé¡µé¢ä¸­çš„abcå˜ä¸ºcbaã€‚
*/</span>
</code></pre></div><h3 id="update-è®¡ç®—"><a href="#update-è®¡ç®—" class="header-anchor">#</a> update è®¡ç®—</h3> <h3 id="ä¼˜å…ˆçº§è°ƒåº¦"><a href="#ä¼˜å…ˆçº§è°ƒåº¦" class="header-anchor">#</a> ä¼˜å…ˆçº§è°ƒåº¦</h3> <h2 id="commit-é˜¶æ®µ"><a href="#commit-é˜¶æ®µ" class="header-anchor">#</a> commit é˜¶æ®µ</h2></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">ä¸Šæ¬¡æ›´æ–°:</span> <span class="time">4/19/2023, 11:36:36 AM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.fe865785.js" defer></script><script src="/assets/js/2.2bb9bc7d.js" defer></script><script src="/assets/js/23.7f4e1523.js" defer></script>
  </body>
</html>
